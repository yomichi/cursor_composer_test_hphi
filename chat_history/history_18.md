### #18

#### In

未実装のテストはそのままで大丈夫です。
`run_calculations.py` について、先にテストを作成しましょう。
`generate_input.py` と同様に、仕様をmdファイルに日本語で書いてください。
また、pytestを利用するなど、共通部分はまとめて別ファイルに移してください。
共通部分は `tests/generate_input.py.md` から削除してください。

#### Out

まず、テストの共通部分を新しいファイルに移動します。

````markdown:references/tests/common.md
# テストの共通仕様

## テスト環境の準備

### フィクスチャ
- 一時ディレクトリの作成と削除
- テスト用の引数セットの準備
- 権限制御のためのヘルパー関数

### モック
- 必要に応じてファイルシステム操作をモック化
- 標準出力・標準エラー出力のキャプチャ

## テストフレームワークと実行方法

### 使用ツール
- `pytest`：テストフレームワーク
- `pytest-cov`：カバレッジ計測
- `pytest-mock`：モック機能

### テストの実行方法
```bash
# 全テストの実行
pytest tests/test_*.py -v

# カバレッジレポート付きで実行
pytest tests/test_*.py --cov=src --cov-report=term-missing
```
````

次に、`run_calculations.py`のテスト仕様を作成します。

````markdown:references/tests/run_calculations.py.md
# run_calculations.py のテスト戦略

## 1. ユニットテスト

### コマンドライン引数のパース（`test_parse_args`）
- デフォルト値の確認
  - `--work-dir`が`.`になっているか
- 各引数の型の確認
  - `work_dir`が文字列型か
- 不正な入力のエラー処理
  - 存在しないディレクトリを指定した場合

### 計算ディレクトリの検索（`test_find_calculation_dirs`）
- 正常系
  - 指定したディレクトリ内のN*ディレクトリを検出できるか
  - ディレクトリのソート順が正しいか（N4, N6, N8, ...）
- 異常系
  - dataディレクトリが存在しない場合
  - N*ディレクトリが存在しない場合
  - StdFace.defが存在しない場合

### HPhi実行（`test_run_hphi`）
- 正常系
  - HPhi実行時の作業ディレクトリの変更
  - HPhi実行時のコマンド
  - 実行結果の確認
- 異常系
  - HPhi実行失敗時のエラー処理
  - 実行権限がない場合のエラー処理

### 結果の移動（`test_move_results`）
- 正常系
  - 結果ファイルの移動
  - ディレクトリ構造の確認
  - ファイルの存在確認
- 異常系
  - 移動先ディレクトリの作成失敗
  - 結果ファイルが存在しない場合
  - 移動先に同名ファイルが存在する場合

## 2. 統合テスト

### メイン処理の実行（`test_main`）
- 正常系
  - 全体の処理が正しく実行されるか
  - 結果ファイルの配置確認
  - 進捗表示の確認
- 異常系
  - エラー時の終了コードの確認
  - エラーメッセージの出力確認

## 3. テストケースの優先順位

### 1. 基本機能のテスト
- [ ] コマンドライン引数の処理
  - [ ] デフォルト値の確認
  - [ ] カスタム値の確認
- [ ] 計算ディレクトリの検索
  - [ ] ディレクトリの検出
  - [ ] ソート順の確認

### 2. HPhi実行のテスト
- [ ] HPhi実行の制御
  - [ ] コマンド実行
  - [ ] 作業ディレクトリの管理
- [ ] 実行結果の確認
  - [ ] 終了コードの確認
  - [ ] 出力ファイルの確認

### 3. 結果ファイルの管理
- [ ] 結果ディレクトリの作成
  - [ ] ディレクトリ構造の作成
  - [ ] 権限の確認
- [ ] ファイルの移動
  - [ ] ファイルのコピー
  - [ ] 元ファイルの削除

### 4. エッジケース
- [ ] エラー処理
  - [ ] HPhi実行エラー
  - [ ] ファイル操作エラー
  - [ ] 権限エラー
- [ ] 異常な状況
  - [ ] 不完全な計算結果
  - [ ] 破損したファイル
  - [ ] 予期しないディレクトリ構造
````


最後に、`generate_input.py.md`から共通部分を削除します。

````markdown:references/tests/generate_input.py.md
# generate_input.py のテスト戦略

## 1. ユニットテスト

### コマンドライン引数のパース（`test_parse_args`）
- デフォルト値の確認
  - `--work-dir`が`.`になっているか
  - `--2s`が1になっているか
  - `--delta`が1.0になっているか
  - `--sizes`が`[4,6,8,10,12]`になっているか
- 各引数の型の確認
  - `work_dir`が文字列型か
  - `two_s`が整数型か
  - `delta`が浮動小数点型か
  - `sizes`が整数のリストか
- 不正な入力のエラー処理
  - `--sizes`に不正な形式を与えた場合のエラー

### パラメータの検証（`test_validate_parameters`）
- 正常なパラメータの確認
- 不正なパラメータでのエラー発生
  - `two_s <= 0`の場合
  - `sizes`に0以下の値が含まれる場合

### ディレクトリ作成（`test_setup_directories`）
- 正常系
  - 指定したディレクトリ構造が作成されるか
  - 既存のディレクトリがある場合に正しく動作するか
- 異常系
  - 権限がない場合のエラー処理

### StdFace.defの生成（`test_generate_stdface`）
- 出力内容の検証
  - 必須パラメータが含まれているか
  - パラメータの値が正しく設定されているか
  - 改行コードが適切か

### ファイル書き込み（`test_write_input_files`）
- 正常系
  - ファイルが正しく作成されるか
  - ファイル内容が正しいか
- 異常系
  - 書き込み権限がない場合のエラー処理

## 2. 統合テスト

### メイン処理の実行（`test_main`）
- 正常系
  - 全体の処理が正しく実行されるか
  - 作成されたファイルとディレクトリの確認
- 異常系
  - エラー時の終了コードの確認
  - エラーメッセージの出力確認

## 3. テストケースの優先順位

### 1. 基本機能のテスト
- [x] コマンドライン引数の処理
  - [x] デフォルト値の確認
  - [x] カスタム値の確認
  - [x] 型の確認
- [x] 基本的なファイル生成
  - [x] StdFace.defの生成
  - [x] パラメータの正しい設定
  - [x] ファイル内容の検証

### 2. 入力値の検証
- [x] パラメータの妥当性チェック
  - [x] 2Sの正の値チェック
  - [x] サイズの正の値チェック
- [x] エラー処理
  - [x] 不正なサイズリストのフォーマット
  - [x] 不正なパラメータ値

### 3. ファイルシステム操作
- [x] ディレクトリ作成
  - [x] 基本的なディレクトリ構造の作成
  - [x] 既存ディレクトリの処理
- [x] ファイル書き込み
  - [x] ファイルの作成確認
  - [x] ファイル内容の検証

### 4. エッジケース
- [ ] 既存ファイルの扱い
  - [ ] 上書き時の動作確認
  - [ ] バックアップの確認
- [ ] 権限エラー
  - [ ] 書き込み権限がない場合
  - [ ] 読み取り権限がない場合
- [ ] 不正な入力値
  - [ ] 極端に大きな値
  - [ ] 特殊文字を含むパス
  - [ ] Unicode文字を含むパス
````

3つのファイルを作成・更新しました：

1. `references/tests/common.md`
   - テストの共通仕様
   - フィクスチャとモックの説明
   - テストフレームワークと実行方法

2. `references/tests/run_calculations.py.md`
   - `run_calculations.py`のテスト戦略
   - ユニットテストと統合テストの詳細
   - テストケースの優先順位

3. `references/tests/generate_input.py.md`
   - 共通部分を削除
   - スクリプト固有のテスト仕様のみを残す

次のステップとして、`run_calculations.py`のテストコードを実装しましょうか？


