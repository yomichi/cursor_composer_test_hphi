### #20

`references/src/run_calculation.py.md` を手で更新してあったが、それが反映されていないようだった。#18 をやり直す。

手で更新したファイルについては、contextに明示的に追加したほうが良さそう。

#### In

未実装のテストはそのままで大丈夫です。
`run_calculations.py` について、先にテストを作成しましょう。
`generate_input.py` と同様に、仕様をmdファイルに日本語で書いてください。
`run_calculations.py` の仕様ファイル、 `references/src/run_calculations.py.md` が更新されているので、改めて確認してください。

また、pytestを利用するなど、テストの共通部分はまとめて別ファイルに移してください。
共通部分は `tests/generate_input.py.md` からも削除してください。

#### Out

まず、テストの共通部分を新しいファイルに移動します。

````markdown:references/tests/common.md
# テストの共通仕様

## テスト環境の準備

### フィクスチャ
- 一時ディレクトリの作成と削除
  - `temp_work_dir`：pytestの`tmp_path`を利用
  - テスト終了時に自動的に削除

### モック
- 必要に応じてファイルシステム操作をモック化
- 標準出力・標準エラー出力のキャプチャ（`capsys`）

## テストフレームワークと実行方法

### 使用ツール
- `pytest`：テストフレームワーク
- `pytest-cov`：カバレッジ計測
- `pytest-mock`：モック機能

### テストの実行方法
```bash
# 全テストの実行
pytest tests/ -v

# 特定のテストファイルの実行
pytest tests/test_generate_input.py -v
pytest tests/test_run_calculations.py -v

# カバレッジレポート付きで実行
pytest tests/ --cov=src --cov-report=term-missing
```

## テストコードの方針
- 英語でコメントとdocstringを記述
- NumPyスタイルのdocstringを使用
- テストケースは機能ごとにクラスでグループ化
- 正常系と異常系のテストを明確に区別
````

次に、`run_calculations.py`のテスト仕様を作成します。

````markdown:references/tests/run_calculations.py.md
# run_calculations.py のテスト戦略

## 1. ユニットテスト

### コマンドライン引数のパース（`test_parse_args`）
- デフォルト値の確認
  - `--work-dir`が`.`になっているか
  - `--hphi`が`HPhi`になっているか
- 各引数の型の確認
  - `work_dir`が文字列型か
  - `hphi`が文字列型か
- 不正な入力のエラー処理
  - 存在しないディレクトリを指定した場合
  - 実行権限のないHPhiを指定した場合

### 計算ディレクトリの検索（`test_find_calc_dirs`）
- 正常系
  - `data/N*`ディレクトリの検出
  - ディレクトリのソート順の確認
- 異常系
  - データディレクトリが存在しない場合
  - 計算ディレクトリが見つからない場合

### HPhi実行（`test_run_hphi`）
- 正常系
  - HPhi実行時の戻り値の確認
  - 出力ファイルの生成確認
- 異常系
  - HPhi実行失敗時のエラー処理
  - タイムアウト時の処理

### 結果の移動（`test_move_results`）
- 正常系
  - 結果ファイルの移動確認
  - ディレクトリ構造の確認
- 異常系
  - 移動先ディレクトリの作成失敗
  - 結果ファイルが存在しない場合

## 2. 統合テスト

### メイン処理の実行（`test_main`）
- 正常系
  - 全体の処理フローの確認
  - 結果ファイルの配置確認
- 異常系
  - HPhi実行エラー時の処理
  - 途中でのエラー発生時の後処理

## 3. テストケースの優先順位

### 1. 基本機能のテスト
- [ ] コマンドライン引数の処理
  - [ ] デフォルト値の確認
  - [ ] カスタム値の確認
  - [ ] 型の確認
- [ ] HPhi実行の基本機能
  - [ ] コマンド実行
  - [ ] 出力ファイルの確認

### 2. 入力値の検証
- [ ] パラメータの妥当性チェック
  - [ ] 作業ディレクトリの存在確認
  - [ ] HPhi実行ファイルの確認
- [ ] エラー処理
  - [ ] 不正なパス
  - [ ] 権限エラー

### 3. ファイルシステム操作
- [ ] 結果ディレクトリの作成
  - [ ] ディレクトリ構造の作成
  - [ ] 既存ディレクトリの処理
- [ ] 結果ファイルの移動
  - [ ] ファイルの移動確認
  - [ ] 移動後の内容確認

### 4. エッジケース
- [ ] 実行時エラー
  - [ ] HPhi実行失敗
  - [ ] タイムアウト
  - [ ] 中断処理
- [ ] 並行実行
  - [ ] 複数プロセスでの実行
  - [ ] ロック機構の確認
````


最後に、`generate_input.py`のテスト仕様から共通部分を削除します。

````markdown:references/tests/generate_input.py.md
# generate_input.py のテスト戦略

## 1. ユニットテスト

### コマンドライン引数のパース（`test_parse_args`）
- デフォルト値の確認
  - `--work-dir`が`.`になっているか
  - `--2s`が1になっているか
  - `--delta`が1.0になっているか
  - `--sizes`が`[4,6,8,10,12]`になっているか
- 各引数の型の確認
  - `work_dir`が文字列型か
  - `two_s`が整数型か
  - `delta`が浮動小数点型か
  - `sizes`が整数のリストか
- 不正な入力のエラー処理
  - `--sizes`に不正な形式を与えた場合のエラー

### パラメータの検証（`test_validate_parameters`）
- 正常なパラメータの確認
- 不正なパラメータでのエラー発生
  - `two_s <= 0`の場合
  - `sizes`に0以下の値が含まれる場合

### ディレクトリ作成（`test_setup_directories`）
- 正常系
  - 指定したディレクトリ構造が作成されるか
  - 既存のディレクトリがある場合に正しく動作するか
- 異常系
  - 権限がない場合のエラー処理

### StdFace.defの生成（`test_generate_stdface`）
- 出力内容の検証
  - 必須パラメータが含まれているか
  - パラメータの値が正しく設定されているか
  - 改行コードが適切か

### ファイル書き込み（`test_write_input_files`）
- 正常系
  - ファイルが正しく作成されるか
  - ファイル内容が正しいか
- 異常系
  - 書き込み権限がない場合のエラー処理

## 2. 統合テスト

### メイン処理の実行（`test_main`）
- 正常系
  - 全体の処理が正しく実行されるか
  - 作成されたファイルとディレクトリの確認
- 異常系
  - エラー時の終了コードの確認
  - エラーメッセージの出力確認

## 3. テストケースの優先順位

### 1. 基本機能のテスト
- [x] コマンドライン引数の処理
  - [x] デフォルト値の確認
  - [x] カスタム値の確認
  - [x] 型の確認
- [x] 基本的なファイル生成
  - [x] StdFace.defの生成
  - [x] パラメータの正しい設定
  - [x] ファイル内容の検証

### 2. 入力値の検証
- [x] パラメータの妥当性チェック
  - [x] 2Sの正の値チェック
  - [x] サイズの正の値チェック
- [x] エラー処理
  - [x] 不正なサイズリストのフォーマット
  - [x] 不正なパラメータ値

### 3. ファイルシステム操作
- [x] ディレクトリ作成
  - [x] 基本的なディレクトリ構造の作成
  - [x] 既存ディレクトリの処理
- [x] ファイル書き込み
  - [x] ファイルの作成確認
  - [x] ファイル内容の検証

### 4. エッジケース
- [ ] 既存ファイルの扱い
  - [ ] 上書き時の動作確認
  - [ ] バックアップの確認
- [ ] 権限エラー
  - [ ] 書き込み権限がない場合
  - [ ] 読み取り権限がない場合
- [ ] 不正な入力値
  - [ ] 極端に大きな値
  - [ ] 特殊文字を含むパス
  - [ ] Unicode文字を含むパス
````

3つのファイルを作成・更新しました：

1. `references/tests/common.md`（新規作成）
   - テストの共通仕様
   - フィクスチャとモックの使用方法
   - テストフレームワークと実行方法

2. `references/tests/run_calculations.py.md`（新規作成）
   - `run_calculations.py`のテスト戦略
   - ユニットテストと統合テストの仕様
   - テストケースの優先順位

3. `references/tests/generate_input.py.md`（更新）
   - 共通部分を削除
   - テストケース部分のみ残す

次のステップとして、`run_calculations.py`のテストコードの実装を始めましょうか？


