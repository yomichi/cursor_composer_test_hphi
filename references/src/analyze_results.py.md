# analyze_results.py 仕様書

## 概要
HPhi計算結果からエネルギーギャップを計算し、サイズ依存性を解析するスクリプト。

## コマンドライン引数

### --work-dir
- 作業ディレクトリを指定
- デフォルト値: `.`（カレントディレクトリ）
- 指定されたディレクトリが存在しない場合はエラー

### --format
- プロット出力のフォーマットを指定
- デフォルト値: `pdf`
- 指定可能な値:
  - `pdf`: PDF形式で出力
  - `png`: PNG形式で出力
  - `pdf,png`: 両方のフォーマットで出力
- カンマ区切りで複数指定可能
- サポートされていないフォーマットや重複指定はエラー

## 入力ファイル

### zvo_energy.dat
- 場所: `results/raw/N{size}/zvo_energy.dat`
- フォーマット:
  ```
  State 0
    Energy  [基底状態のエネルギー]
    Doublon [その他の物理量]
    Sz      [その他の物理量]

  State 1
    Energy  [第一励起状態のエネルギー]
    Doublon [その他の物理量]
    Sz      [その他の物理量]
  ```
- 要件:
  - State 0（基底状態）とState 1（第一励起状態）が必須
  - エネルギー値は10桁の浮動小数点数
  - E₁ > E₀であること

## 出力ファイル

### energy_gap.dat
- 場所: 作業ディレクトリ直下
- フォーマット:
  ```
  # N      E0          E1          Gap         1/N
    4     -7.10436759 -6.98765432  0.11671327  0.25000000
    6     -12.12345680 -11.98765430  0.13580246  0.16666667
    8     -16.12345680 -15.98765430  0.13580246  0.12500000
  #
  # Linear fit: gap = ax + b
  # a = [傾き]
  # b = [切片]
  # Gap(N→∞) = [外挿値]
  ```

### energy_gap.{format}
- 場所: 作業ディレクトリ直下
- フォーマット: `--format`オプションで指定（pdf/png）
- 内容:
  - 横軸: 1/N
  - 縦軸: エネルギーギャップ
  - プロット要素:
    - データ点（青丸）
    - フィッティング直線（破線）
    - N→∞への外挿点（赤い星印）
  - 凡例:
    - データ点
    - フィッティングパラメータ
    - 外挿値

## エラー処理
1. コマンドライン引数
   - 存在しないディレクトリの指定
   - サポートされていないフォーマットの指定
   - フォーマットの重複指定

2. 入力ファイル
   - 結果ディレクトリが存在しない
   - zvo_energy.datが存在しない
   - ファイルフォーマットが不正
   - 必要な状態（State 0, 1）が存在しない
   - エネルギー値の順序が不正（E₁ < E₀）

3. 出力ファイル
   - 書き込み権限がない
   - ディスク容量不足

## 機能
- 各サイズの計算結果からエネルギー固有値を読み取り
- エネルギーギャップを計算
- サイズ依存性のプロット生成
- （オプション）有限サイズスケーリング解析

## 使用例
```bash
# カレントディレクトリで実行
python src/analyze_results.py

# 作業ディレクトリを指定
python src/analyze_results.py --work-dir ./work
``` 
